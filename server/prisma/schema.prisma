// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. USUARIOS Y ROLES
enum Role {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id                  Int          @id @default(autoincrement())
  email               String       @unique
  password            String
  fullName            String
  role                Role         @default(STUDENT)
  createdAt           DateTime     @default(now())
  
  // Relación con Carrera
  careerId            Int?
  career              Career?      @relation(fields: [careerId], references: [id])

  enrollments         Enrollment[]
  teachingAssignments Parallel[]

  tutoringsCreated Tutoring[] @relation("TeacherTutorings")
  tutoringBookings TutoringBooking[]
  activityGrades ActivityGrade[]
}

model Career {
  id             Int       @id @default(autoincrement())
  name           String
  totalSemesters Int
  subjects       Subject[]
  users          User[]
}

model Subject {
  id            Int          @id @default(autoincrement())
  name          String
  semesterLevel Int
  
  careerId      Int
  career        Career       @relation(fields: [careerId], references: [id])
  
  parallels     Parallel[]
  enrollments   Enrollment[]
  
  // --- AGREGA SOLO ESTA LÍNEA ---
  tutorings     Tutoring[] 
}
// 3. GESTIÓN DE TIEMPO Y PERIODOS
model AcademicPeriod {
  id        Int        @id @default(autoincrement())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean    @default(false)
  
  parallels Parallel[]
}

model Parallel {
  id        Int            @id @default(autoincrement())
  code      String
  capacity  Int            @default(30)
  
  subjectId Int
  subject   Subject        @relation(fields: [subjectId], references: [id])
  
  periodId  Int
  period    AcademicPeriod @relation(fields: [periodId], references: [id])
  
  teacherId Int?
  teacher   User?          @relation(fields: [teacherId], references: [id])
  
  schedules Schedule[]

  events      Event[]
  activities Activity[]
  enrollments Enrollment[]

  // NOTA: He quitado la relación 'enrollments' aquí temporalmente porque
  // 'Enrollment' ahora está vinculado a 'Subject', no a 'Parallel'.
  // Más adelante crearemos una tabla 'ClassRegistration' para la toma de horarios.

  @@unique([periodId, subjectId, code])

}

// 4. HORARIOS FIJOS
model Schedule {
  id         Int      @id @default(autoincrement())
  dayOfWeek  Int
  startTime  String
  endTime    String
  
  parallelId Int
  parallel   Parallel @relation(fields: [parallelId], references: [id])
}

// 5. HISTORIAL ACADÉMICO (Enrollment Definitivo)
enum AcademicStatus {
  PENDING
  TAKING
  APPROVED
  FAILED
}

model Enrollment {
  id         Int            @id @default(autoincrement())
  status     AcademicStatus @default(PENDING)
  finalGrade Float?         // Nota final
  
  userId     Int
  user       User           @relation(fields: [userId], references: [id])
  
  subjectId  Int
  subject    Subject        @relation(fields: [subjectId], references: [id])


  parallelId Int?             // (Opcional por ahora para no romper datos viejos)
  parallel   Parallel?        @relation(fields: [parallelId], references: [id])


  attendance Attendance[]

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([userId, subjectId]) 
}

// ... modelos anteriores ...

// MODELO DE TUTORÍAS (Para el futuro módulo de Calendario)
model Tutoring {
  id        Int      @id @default(autoincrement())
  date      DateTime // Fecha y Hora
  capacity  Int      // Cupos disponibles
  notes     String?  // Tema o descripción
  
  // Relación con el Profe
  teacherId Int
  teacher   User     @relation("TeacherTutorings", fields: [teacherId], references: [id])
  
  // Relación con Materia (Opcional, puede ser tutoría general)
  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  
  // Lista de estudiantes inscritos
  bookings  TutoringBooking[]
  
  createdAt DateTime @default(now())
}

// TABLA INTERMEDIA (Estudiantes inscritos en la tutoría)
model TutoringBooking {
  id         Int      @id @default(autoincrement())
  tutoringId Int
  tutoring   Tutoring @relation(fields: [tutoringId], references: [id])
  
  studentId  Int
  student    User     @relation(fields: [studentId], references: [id])
  
  createdAt  DateTime @default(now())
}

// --- NUEVOS MODELOS PARA ACTIVIDADES ---

model Activity {
  id          Int      @id @default(autoincrement())
  name        String   // Ej: "Ensayo de Historia", "Examen 1"
  description String?
  type        String   // INDIVIDUAL, GRUPAL, MEDIO, FINAL
  maxScore    Float    // Ej: 7, 5, 2, 6
  
  parallelId  Int
  parallel    Parallel @relation(fields: [parallelId], references: [id])
  
  grades      ActivityGrade[]
  
  createdAt   DateTime @default(now())
}

model ActivityGrade {
  id             Int      @id @default(autoincrement())
  score          Float?   
  feedback       String? 
  submissionLink String?  
  submittedAt    DateTime? @default(now())
  
  // Relación antigua (Opcional ahora)
  activityId  Int?
  activity    Activity? @relation(fields: [activityId], references: [id])

  // Relación nueva (Con Eventos)
  eventId     Int?
  event       Event?    @relation(fields: [eventId], references: [id])
  
  studentId   Int
  student     User      @relation(fields: [studentId], references: [id])
  
  createdAt   DateTime @default(now())

  // Claves únicas para evitar duplicados
  @@unique([studentId, eventId])
  @@unique([activityId, studentId])
}

// 1. AGREGA ESTO AL FINAL DEL ARCHIVO
model Attendance {
  id           Int      @id @default(autoincrement())
  date         DateTime @db.Date // Solo nos interesa la fecha
  status       AttendanceStatus @default(PRESENT)
  
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  enrollmentId Int

  // Evita duplicados: Un estudiante solo puede tener una asistencia por día
  @@unique([date, enrollmentId]) 
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

// 1. AGREGA ESTO AL FINAL
model Event {
  id          Int      @id @default(autoincrement())
  title       String   // Ej: "Examen Parcial 1"
  description String?
  date        DateTime // Fecha y hora del evento
  type        String   // INDIVIDUAL, GRUPAL, MEDIO, FINAL (Para saber a qué categoría pertenece)


  activityGrades ActivityGrade[]
  parallel    Parallel @relation(fields: [parallelId], references: [id])
  parallelId  Int
}