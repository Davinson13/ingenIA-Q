// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// 1. USERS AND ROLES
// --------------------------------------------------------

enum Role {
  STUDENT
  TEACHER
  ADMIN
  GUEST
}

model User {
  id               Int      @id @default(autoincrement())
  email            String   @unique
  password         String?  // Optional: OAuth users won't have a password
  fullName         String
  role             String   @default("GUEST") // STUDENT, TEACHER, ADMIN, GUEST
  
  isVerified       Boolean  @default(false)
  verificationCode String?  // Temporary code for email verification
  provider         String   @default("LOCAL") // LOCAL, GOOGLE, GITHUB
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // --- Relations ---
  careerId            Int?
  career              Career?           @relation(fields: [careerId], references: [id])
  currentSemester     Int?              // e.g., 4
  enrollments         Enrollment[]
  teachingAssignments Parallel[]
  tutoringsCreated    Tutoring[]        @relation("TeacherTutorings")
  tutoringBookings    TutoringBooking[]
  activityGrades      ActivityGrade[]
  personalEvents      PersonalEvent[]
  externalCourses     ExternalCourse[]
  requestingCareer    Boolean           @default(false)
}

// --------------------------------------------------------
// 2. ACADEMIC STRUCTURE
// --------------------------------------------------------

model Career {
  id             Int       @id @default(autoincrement())
  name           String
  totalSemesters Int
  subjects       Subject[]
  users          User[]
}

model Subject {
  id            Int          @id @default(autoincrement())
  name          String
  semesterLevel Int
  
  careerId      Int
  career        Career       @relation(fields: [careerId], references: [id])
  
  parallels     Parallel[]
  enrollments   Enrollment[]
  tutorings     Tutoring[]   // Relation to Tutorings
}

// --------------------------------------------------------
// 3. TIME MANAGEMENT & PERIODS
// --------------------------------------------------------

model AcademicPeriod {
  id        Int        @id @default(autoincrement())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean    @default(false)
  
  parallels Parallel[]
}

model Parallel {
  id        Int            @id @default(autoincrement())
  code      String         // e.g., "A", "B"
  capacity  Int            @default(30)
  
  subjectId Int
  subject   Subject        @relation(fields: [subjectId], references: [id])
  
  periodId  Int
  period    AcademicPeriod @relation(fields: [periodId], references: [id])
  
  teacherId Int?
  teacher   User?          @relation(fields: [teacherId], references: [id])
  
  schedules   Schedule[]
  events      Event[]
  activities  Activity[]
  enrollments Enrollment[]

  // Note: 'enrollments' relation here might need a separate 'ClassRegistration' 
  // table later if managing specific schedule enrollments distinct from subject enrollment.

  @@unique([periodId, subjectId, code])
}

// --------------------------------------------------------
// 4. FIXED SCHEDULES
// --------------------------------------------------------

model Schedule {
  id         Int      @id @default(autoincrement())
  dayOfWeek  Int      // 1 = Monday, etc.
  startTime  String   // HH:mm
  endTime    String   // HH:mm
  
  parallelId Int
  parallel   Parallel @relation(fields: [parallelId], references: [id])
}

// --------------------------------------------------------
// 5. ACADEMIC HISTORY & ENROLLMENT
// --------------------------------------------------------

enum AcademicStatus {
  PENDING
  TAKING
  APPROVED
  FAILED
}

model Enrollment {
  id         Int            @id @default(autoincrement())
  status     AcademicStatus @default(PENDING)
  finalGrade Float?         // Final grade for the subject
  
  userId     Int
  user       User           @relation(fields: [userId], references: [id])
  
  subjectId  Int
  subject    Subject        @relation(fields: [subjectId], references: [id])

  parallelId Int?           // Optional to maintain backward compatibility
  parallel   Parallel?      @relation(fields: [parallelId], references: [id])

  attendance Attendance[]

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([userId, subjectId]) 
}

// --------------------------------------------------------
// 6. TUTORING SYSTEM
// --------------------------------------------------------

model Tutoring {
  id        Int      @id @default(autoincrement())
  date      DateTime
  capacity  Int
  notes     String?
  
  modality  String   @default("PRESENCIAL") // "PRESENCIAL" or "VIRTUAL"

  teacherId Int
  teacher   User     @relation("TeacherTutorings", fields: [teacherId], references: [id])
  
  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  
  bookings  TutoringBooking[]
  createdAt DateTime @default(now())
}

// Join Table: Students booked for a tutoring session
model TutoringBooking {
  id         Int      @id @default(autoincrement())
  tutoringId Int
  tutoring   Tutoring @relation(fields: [tutoringId], references: [id])
  
  studentId  Int
  student    User     @relation(fields: [studentId], references: [id])
  
  createdAt  DateTime @default(now())
}

// --------------------------------------------------------
// 7. ACTIVITIES & GRADING
// --------------------------------------------------------

model Activity {
  id          Int      @id @default(autoincrement())
  name        String   // e.g., "History Essay", "Exam 1"
  description String?
  type        String   // INDIVIDUAL, GRUPAL, MEDIO, FINAL
  maxScore    Float    // e.g., 7, 5, 2, 6
  
  parallelId  Int
  parallel    Parallel @relation(fields: [parallelId], references: [id])
  
  grades      ActivityGrade[]
  
  createdAt   DateTime @default(now())
}

model ActivityGrade {
  id             Int       @id @default(autoincrement())
  score          Float?    
  feedback       String?   
  submissionLink String?   
  submittedAt    DateTime? @default(now())
  
  // Old Relation (Optional now)
  activityId     Int?
  activity       Activity? @relation(fields: [activityId], references: [id])

  // New Relation (With Events)
  eventId        Int?
  event          Event?    @relation(fields: [eventId], references: [id])
  
  studentId      Int
  student        User      @relation(fields: [studentId], references: [id])
  
  createdAt      DateTime  @default(now())

  // Unique constraints to prevent duplicates
  @@unique([studentId, eventId])
  @@unique([activityId, studentId])
}

// --------------------------------------------------------
// 8. ATTENDANCE
// --------------------------------------------------------

model Attendance {
  id           Int              @id @default(autoincrement())
  date         DateTime         @db.Date // Only date matters, not time
  status       AttendanceStatus @default(PRESENT)
  
  enrollment   Enrollment       @relation(fields: [enrollmentId], references: [id])
  enrollmentId Int

  // Prevent duplicates: A student can only have one attendance record per day per enrollment
  @@unique([date, enrollmentId]) 
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

// --------------------------------------------------------
// 9. EVENTS & CALENDAR
// --------------------------------------------------------

model Event {
  id             Int             @id @default(autoincrement())
  title          String          // e.g., "Midterm Exam 1"
  description    String?
  date           DateTime        // Event date and time
  type           String          // INDIVIDUAL, GRUPAL, MEDIO, FINAL (Category)

  activityGrades ActivityGrade[]
  parallel       Parallel        @relation(fields: [parallelId], references: [id])
  parallelId     Int
}

// Personal / Extracurricular Events
model PersonalEvent {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  date        DateTime
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
}

// --------------------------------------------------------
// 10. EXTERNAL COURSES
// --------------------------------------------------------

model ExternalCourse {
  id          Int      @id @default(autoincrement())
  name        String   // e.g., "English Course"
  description String?
  
  startTime   String   // "14:00"
  endTime     String   // "16:00"
  days        String   // "1,3,5" (Monday, Wednesday, Friday)
  
  startDate   DateTime // Start date
  endDate     DateTime // End date

  studentId   Int
  student     User     @relation(fields: [studentId], references: [id])
}