// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. USUARIOS Y ROLES
enum Role {
  STUDENT
  TEACHER
  ADMIN
  GUEST
}

model User {
  id                  Int          @id @default(autoincrement())
  email               String       @unique
  password  String?  // Opcional porque con OAuth no hay password
  fullName            String
  role      String   @default("GUEST") // STUDENT, TEACHER, ADMIN, GUEST
  
  isVerified       Boolean @default(false)
  verificationCode String? // C√≥digo temporal para verificar email
  provider         String  @default("LOCAL") // LOCAL, GOOGLE, GITHUB
  createdAt           DateTime     @default(now())
  updatedAt DateTime @updatedAt
  
  // Relaci√≥nes
  careerId            Int?
  career              Career?      @relation(fields: [careerId], references: [id])
  enrollments         Enrollment[]
  teachingAssignments Parallel[]
  tutoringsCreated Tutoring[] @relation("TeacherTutorings")
  tutoringBookings TutoringBooking[]
  activityGrades ActivityGrade[]
  personalEvents PersonalEvent[]
  externalCourses ExternalCourse[]
}

model Career {
  id             Int       @id @default(autoincrement())
  name           String
  totalSemesters Int
  subjects       Subject[]
  users          User[]
}

model Subject {
  id            Int          @id @default(autoincrement())
  name          String
  semesterLevel Int
  
  careerId      Int
  career        Career       @relation(fields: [careerId], references: [id])
  
  parallels     Parallel[]
  enrollments   Enrollment[]
  
  // --- AGREGA SOLO ESTA L√çNEA ---
  tutorings     Tutoring[] 
}
// 3. GESTI√ìN DE TIEMPO Y PERIODOS
model AcademicPeriod {
  id        Int        @id @default(autoincrement())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean    @default(false)
  
  parallels Parallel[]
}

model Parallel {
  id        Int            @id @default(autoincrement())
  code      String
  capacity  Int            @default(30)
  
  subjectId Int
  subject   Subject        @relation(fields: [subjectId], references: [id])
  
  periodId  Int
  period    AcademicPeriod @relation(fields: [periodId], references: [id])
  
  teacherId Int?
  teacher   User?          @relation(fields: [teacherId], references: [id])
  
  schedules Schedule[]

  events      Event[]
  activities Activity[]
  enrollments Enrollment[]

  // NOTA: He quitado la relaci√≥n 'enrollments' aqu√≠ temporalmente porque
  // 'Enrollment' ahora est√° vinculado a 'Subject', no a 'Parallel'.
  // M√°s adelante crearemos una tabla 'ClassRegistration' para la toma de horarios.

  @@unique([periodId, subjectId, code])

}

// 4. HORARIOS FIJOS
model Schedule {
  id         Int      @id @default(autoincrement())
  dayOfWeek  Int
  startTime  String
  endTime    String
  
  parallelId Int
  parallel   Parallel @relation(fields: [parallelId], references: [id])
}

// 5. HISTORIAL ACAD√âMICO (Enrollment Definitivo)
enum AcademicStatus {
  PENDING
  TAKING
  APPROVED
  FAILED
}

model Enrollment {
  id         Int            @id @default(autoincrement())
  status     AcademicStatus @default(PENDING)
  finalGrade Float?         // Nota final
  
  userId     Int
  user       User           @relation(fields: [userId], references: [id])
  
  subjectId  Int
  subject    Subject        @relation(fields: [subjectId], references: [id])


  parallelId Int?             // (Opcional por ahora para no romper datos viejos)
  parallel   Parallel?        @relation(fields: [parallelId], references: [id])


  attendance Attendance[]

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([userId, subjectId]) 
}

// ... modelos anteriores ...

// Busca el modelo Tutoring y agrega esto:
model Tutoring {
  id        Int      @id @default(autoincrement())
  date      DateTime
  capacity  Int
  notes     String?
  
  // üëá NUEVO CAMPO
  modality  String   @default("PRESENCIAL") // "PRESENCIAL" o "VIRTUAL"

  teacherId Int
  teacher   User     @relation("TeacherTutorings", fields: [teacherId], references: [id])
  
  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  
  bookings  TutoringBooking[]
  createdAt DateTime @default(now())
}

// TABLA INTERMEDIA (Estudiantes inscritos en la tutor√≠a)
model TutoringBooking {
  id         Int      @id @default(autoincrement())
  tutoringId Int
  tutoring   Tutoring @relation(fields: [tutoringId], references: [id])
  
  studentId  Int
  student    User     @relation(fields: [studentId], references: [id])
  
  createdAt  DateTime @default(now())
}

// --- NUEVOS MODELOS PARA ACTIVIDADES ---

model Activity {
  id          Int      @id @default(autoincrement())
  name        String   // Ej: "Ensayo de Historia", "Examen 1"
  description String?
  type        String   // INDIVIDUAL, GRUPAL, MEDIO, FINAL
  maxScore    Float    // Ej: 7, 5, 2, 6
  
  parallelId  Int
  parallel    Parallel @relation(fields: [parallelId], references: [id])
  
  grades      ActivityGrade[]
  
  createdAt   DateTime @default(now())
}

model ActivityGrade {
  id             Int      @id @default(autoincrement())
  score          Float?   
  feedback       String? 
  submissionLink String?  
  submittedAt    DateTime? @default(now())
  
  // Relaci√≥n antigua (Opcional ahora)
  activityId  Int?
  activity    Activity? @relation(fields: [activityId], references: [id])

  // Relaci√≥n nueva (Con Eventos)
  eventId     Int?
  event       Event?    @relation(fields: [eventId], references: [id])
  
  studentId   Int
  student     User      @relation(fields: [studentId], references: [id])
  
  createdAt   DateTime @default(now())

  // Claves √∫nicas para evitar duplicados
  @@unique([studentId, eventId])
  @@unique([activityId, studentId])
}

// 1. AGREGA ESTO AL FINAL DEL ARCHIVO
model Attendance {
  id           Int      @id @default(autoincrement())
  date         DateTime @db.Date // Solo nos interesa la fecha
  status       AttendanceStatus @default(PRESENT)
  
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
  enrollmentId Int

  // Evita duplicados: Un estudiante solo puede tener una asistencia por d√≠a
  @@unique([date, enrollmentId]) 
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

// 1. AGREGA ESTO AL FINAL
model Event {
  id          Int      @id @default(autoincrement())
  title       String   // Ej: "Examen Parcial 1"
  description String?
  date        DateTime // Fecha y hora del evento
  type        String   // INDIVIDUAL, GRUPAL, MEDIO, FINAL (Para saber a qu√© categor√≠a pertenece)


  activityGrades ActivityGrade[]
  parallel    Parallel @relation(fields: [parallelId], references: [id])
  parallelId  Int
}

// --- EVENTOS PERSONALES / EXTRACURRICULARES ---
model PersonalEvent {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  date        DateTime
  
  userId   Int
  user     User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
}

// 3. AGREGA EL NUEVO MODELO PARA CURSOS COMPLEMENTARIOS
model ExternalCourse {
  id          Int      @id @default(autoincrement())
  name        String   // Ej: "Curso de Ingl√©s"
  description String?
  
  startTime   String   // "14:00"
  endTime     String   // "16:00"
  days        String   // "1,3,5" (Lunes, Mi√©rcoles, Viernes)
  
  startDate   DateTime // Desde cu√°ndo
  endDate     DateTime // Hasta cu√°ndo

  studentId   Int
  student     User     @relation(fields: [studentId], references: [id])
}